# syntax = docker/dockerfile:1.5

ARG BUILDX_VERSION=0.10.5
ARG DOCKER_VERSION=24.0.2
ARG WAMR_VERSION=1.2.2
ARG WASMEDGE_VERSION=0.12.1
ARG GOLANG_VERSION=1.20.3
ARG WASMER_VERSION=v3.3.0
ARG WASMTIME_VERSION=9.0.3
ARG C2W_OLD_VERSION=ff4cbdb3fda89e03fe5858e83c41507cea2c23d9

FROM docker:${DOCKER_VERSION}-dind AS dind
FROM docker/buildx-bin:${BUILDX_VERSION} AS buildx

FROM golang:1.20 AS wazero-test-dev
COPY ./tests/wazero /wazero
WORKDIR /wazero
RUN go build -o /out/wazero-test main.go

FROM golang:1.20 AS c2w-old-dev
ARG C2W_OLD_VERSION
RUN apt-get update && apt-get install -y git
RUN git clone https://github.com/ktock/container2wasm && \
    cd ./container2wasm && \
    git checkout "${C2W_OLD_VERSION}" && \
    mkdir /out && make -j$(nproc) && mv out/c2w /out/

FROM ubuntu:22.04
ARG BUILDX_VERSION
ARG DOCKER_VERSION
ARG WAMR_VERSION
ARG WASMEDGE_VERSION
ARG GOLANG_VERSION
ARG WASMER_VERSION
ARG WASMTIME_VERSION
ARG C2W_OLD_VERSION

RUN apt-get update && apt-get install -y ca-certificates iptables openssl pigz xz-utils curl wget

# install docker
ENV DOCKER_TLS_CERTDIR=/certs
RUN mkdir /certs /certs/client && chmod 1777 /certs /certs/client
COPY --from=dind /usr/local/bin/ /usr/local/bin/
COPY --from=buildx /buildx /usr/libexec/docker/cli-plugins/docker-buildx
VOLUME /var/lib/docker

# install wasmtime
RUN wget https://github.com/bytecodealliance/wasmtime/releases/download/v${WASMTIME_VERSION}/wasmtime-v${WASMTIME_VERSION}-x86_64-linux.tar.xz && \
    tar -xvf wasmtime-v${WASMTIME_VERSION}-x86_64-linux.tar.xz && \
    mv wasmtime-v${WASMTIME_VERSION}-x86_64-linux/wasmtime /usr/local/bin/

# install wamr
RUN wget https://github.com/bytecodealliance/wasm-micro-runtime/releases/download/WAMR-${WAMR_VERSION}/iwasm-${WAMR_VERSION}-x86_64-ubuntu-20.04.tar.gz && \
    tar -C /usr/local/bin/ -zxvf iwasm-${WAMR_VERSION}-x86_64-ubuntu-20.04.tar.gz
RUN wget https://github.com/bytecodealliance/wasm-micro-runtime/releases/download/WAMR-${WAMR_VERSION}/wamrc-${WAMR_VERSION}-x86_64-ubuntu-20.04.tar.gz && \
    tar -C /usr/local/bin/ -zxvf wamrc-${WAMR_VERSION}-x86_64-ubuntu-20.04.tar.gz

# install wasmer
RUN curl https://get.wasmer.io -sSfL | sh -s ${WASMER_VERSION}
ENV WASMER_DIR="/root/.wasmer"
ENV WASMER_CACHE_DIR="$WASMER_DIR/cache"
ENV PATH="$WASMER_DIR/bin:$PATH:$WASMER_DIR/globals/wapm_packages/.bin"

# install wasmedge
RUN wget https://github.com/WasmEdge/WasmEdge/releases/download/${WASMEDGE_VERSION}/WasmEdge-${WASMEDGE_VERSION}-ubuntu20.04_x86_64.tar.gz && \
    tar zxvf WasmEdge-${WASMEDGE_VERSION}-ubuntu20.04_x86_64.tar.gz && \
    cp -R ./WasmEdge-${WASMEDGE_VERSION}-Linux/* /usr/local/

# install old c2w
COPY --from=c2w-old-dev /out/c2w /usr/local/bin/c2w-old

# install wazero
COPY --from=wazero-test-dev /out/wazero-test /usr/local/bin/

# install golang
RUN wget https://go.dev/dl/go${GOLANG_VERSION}.linux-amd64.tar.gz
RUN tar -C /usr/local -xzf go${GOLANG_VERSION}.linux-amd64.tar.gz
ENV PATH=$PATH:/usr/local/go/bin

# install container2wasm
COPY . /test/
WORKDIR /test/
RUN go build -o /usr/local/bin/ ./cmd/c2w

ENTRYPOINT ["dockerd-entrypoint.sh"]
CMD []
